<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单信息查询系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入SheetJS库用于处理Excel文件 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        neutral: '#F5F7FA',
                        dark: '#1D2129',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .transition-custom {
                transition: all 0.3s ease;
            }
            .progress-animation {
                transition: width 0.2s ease-in-out;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-dark">
    <!-- 全局进度条 -->
    <div id="global-progress-container" class="fixed top-0 left-0 w-full h-2 bg-gray-200 z-50 hidden">
        <div id="global-progress-bar" class="h-full bg-primary progress-animation w-0"></div>
        <div id="progress-text" class="absolute top-4 left-4 bg-dark/80 text-white text-xs px-2 py-1 rounded shadow-md">
            处理中...
        </div>
    </div>

    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-40 transition-custom">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-search text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">订单信息查询系统</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 transition-custom">
                    <i class="fa fa-moon-o text-gray-600"></i>
                </button>
                <button id="help-btn" class="p-2 rounded-full hover:bg-gray-100 transition-custom">
                    <i class="fa fa-question-circle text-gray-600"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- 状态提示 -->
        <div id="status-message" class="hidden mb-6 p-4 rounded-lg flex items-center space-x-3"></div>

        <!-- 数据统计（单行显示，尺寸缩小） -->
        <div class="grid grid-cols-1 mb-6">
            <div class="bg-white rounded-xl p-4 card-shadow hover:shadow-lg transition-custom inline-block">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                        <i class="fa fa-database text-primary text-lg"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">总记录数</p>
                        <h3 id="total-records" class="text-xl font-bold">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- 订单查询区域（上下布局） -->
        <div class="bg-white rounded-xl p-6 card-shadow mb-8">
            <h2 class="text-xl font-bold mb-6 flex items-center">
                <i class="fa fa-search-circle text-primary mr-2"></i>
                订单查询
            </h2>
            
            <div class="grid grid-cols-1 gap-8">
                <!-- 上部：查询表单 -->
                <div>
                    <form id="query-form" class="space-y-6">
                        <div>
                            <label for="tracking-number" class="block text-sm font-medium text-gray-700 mb-1">请输入运单号</label>
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="tracking-number" 
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom"
                                    placeholder="例如：SF1234567890123"
                                    autocomplete="off"
                                >
                                <button 
                                    type="submit" 
                                    class="absolute right-1 top-1 bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-custom"
                                >
                                    查询
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- 下部：查询结果 -->
                <div id="query-result" class="hidden pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">查询结果</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-neutral rounded-lg">
                            <p class="text-sm text-gray-500">运单号</p>
                            <p id="result-waybill-number" class="font-medium"></p>
                        </div>
                        <div class="p-4 bg-neutral rounded-lg">
                            <p class="text-sm text-gray-500">网单号</p>
                            <p id="result-network-number" class="font-medium"></p>
                        </div>
                        <div class="p-4 bg-neutral rounded-lg">
                            <p class="text-sm text-gray-500">主单号</p>
                            <p id="result-main-number" class="font-medium"></p>
                        </div>
                        <div class="p-4 bg-neutral rounded-lg">
                            <p class="text-sm text-gray-500">姓名</p>
                            <p id="result-name" class="font-medium"></p>
                        </div>
                        <div class="p-4 bg-neutral rounded-lg">
                            <p class="text-sm text-gray-500">货主</p>
                            <p id="result-owner" class="font-medium"></p>
                        </div>
                        <div class="p-4 bg-neutral rounded-lg">
                            <p class="text-sm text-gray-500">商品</p>
                            <p id="result-product" class="font-medium"></p>
                        </div>
                        <div class="p-4 bg-neutral rounded-lg">
                            <p class="text-sm text-gray-500">数量</p>
                            <p id="result-quantity" class="font-medium"></p>
                        </div>
                        <div class="p-4 bg-neutral rounded-lg">
                            <p class="text-sm text-gray-500">下单时间</p>
                            <p id="result-purchase-time" class="font-medium"></p>
                        </div>
                        <div class="p-4 bg-neutral rounded-lg">
                            <p class="text-sm text-gray-500">揽收网点</p>
                            <p id="result-collection-point" class="font-medium"></p>
                        </div>
                        <div class="p-4 bg-neutral rounded-lg">
                            <p class="text-sm text-gray-500">责任部门</p>
                            <p id="result-responsible-dept" class="font-medium"></p>
                        </div>
                        <div class="p-4 bg-neutral rounded-lg md:col-span-2">
                            <p class="text-sm text-gray-500">发货备注</p>
                            <p id="result-shipping-notes" class="font-medium"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据明细和导入（数据明细在上，数据导入在下） -->
        <div class="space-y-8">
            <!-- 数据列表（数据明细） -->
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fa fa-table text-primary mr-2"></i>
                        数据明细
                    </h2>
                    <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                        <div class="relative flex-grow sm:flex-grow-0">
                            <input 
                                type="text" 
                                id="table-search" 
                                class="pl-8 pr-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-custom text-sm w-full sm:w-60"
                                placeholder="搜索单号或货主..."
                            >
                            <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                        </div>
                        <button id="clear-all-data" class="text-red-500 hover:text-red-600 transition-custom text-sm p-2 border border-red-200 rounded-lg hover:bg-red-50 whitespace-nowrap">
                            <i class="fa fa-trash mr-1"></i> 清空数据
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">运单号</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">网单号</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">商品</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">数量</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">货主</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">揽收网点</th>
                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <i class="fa fa-file-excel-o text-4xl mb-2 text-gray-300"></i>
                                        <p>暂无数据，请导入Excel文件</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div id="pagination" class="mt-6 flex flex-col sm:flex-row justify-between items-center gap-4 hidden">
                    <p class="text-sm text-gray-500">显示 <span id="showing-range"></span> 条，共 <span id="total-count"></span> 条</p>
                    <div class="flex space-x-1">
                        <button id="prev-page" class="px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            上一页
                        </button>
                        <span id="page-info" class="px-3 py-1 text-sm"></span>
                        <button id="next-page" class="px-3 py-1 rounded border border-gray-300 text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            下一页
                        </button>
                    </div>
                </div>
            </div>

            <!-- 数据导入 -->
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fa fa-upload text-primary mr-2"></i>
                    数据导入
                </h2>
                <div class="space-y-6">
                    <!-- 上传文件 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">上传Excel文件</label>
                        <div id="file-upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-custom cursor-pointer">
                            <input type="file" id="file-upload" accept=".xlsx" class="hidden">
                            <i class="fa fa-file-excel-o text-4xl text-green-500 mb-3"></i>
                            <p class="text-gray-500 mb-2">拖放Excel文件到此处，或点击选择文件</p>
                            <p class="text-xs text-gray-400">支持格式：XLSX（首行为标题行，包含：下单时间,姓名,商品,数量,网单号,运单号,货主,发货备注,主单号,揽收网点,责任部门）</p>
                        </div>
                    </div>

                    <!-- 导入模板 -->
                    <div class="text-center">
                        <button id="download-template" class="text-primary hover:text-primary/80 transition-custom text-sm flex items-center mx-auto">
                            <i class="fa fa-download mr-1"></i> 下载Excel模板
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 详情模态框 -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">订单详情</h3>
                <button id="close-detail" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4 text-sm" id="detail-content">
                <!-- 详情内容将通过JS动态填充 -->
            </div>
        </div>
    </div>

    <!-- 帮助模态框 -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">使用帮助</h3>
                <button id="close-help" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4 text-sm">
                <div>
                    <h4 class="font-medium mb-1">如何导入数据？</h4>
                    <p>通过上传Excel文件导入数据，文件需符合指定格式。</p>
                </div>
                <div>
                    <h4 class="font-medium mb-1">Excel文件格式要求</h4>
                    <p>Excel文件应包含以下列（首行为标题行）：</p>
                    <ul class="list-disc pl-5 mt-1 space-y-1">
                        <li>下单时间（可选，格式：YYYY-MM-DD HH:MM）</li>
                        <li>姓名（可选）</li>
                        <li>商品（可选）</li>
                        <li>数量（可选）</li>
                        <li>网单号（可选）</li>
                        <li>运单号（必填）</li>
                        <li>货主（可选）</li>
                        <li>发货备注（可选）</li>
                        <li>主单号（可选）</li>
                        <li>揽收网点（可选）</li>
                        <li>责任部门（可选）</li>
                    </ul>
                    <p class="mt-1">您可以点击"下载Excel模板"获取正确格式的模板文件。</p>
                </div>
                <div>
                    <h4 class="font-medium mb-1">如何查询？</h4>
                    <p>在查询区域输入运单号，点击"查询"按钮即可获取对应的详细信息。</p>
                </div>
                <div>
                    <h4 class="font-medium mb-1">数据存储</h4>
                    <p>所有数据存储在您的浏览器本地，不会上传到任何服务器，确保您的数据安全。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认对话框 -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4">
            <h3 class="text-xl font-bold mb-2" id="confirm-title">确认操作</h3>
            <p class="text-gray-600 mb-4" id="confirm-message">您确定要执行此操作吗？</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-confirm" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-custom">
                    取消
                </button>
                <button id="confirm-action" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-custom">
                    确认
                </button>
            </div>
        </div>
    </div>

    <footer class="bg-white mt-12 py-6 border-t">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>订单信息查询系统 &copy; 2023</p>
        </div>
    </footer>

    <script>
        // 格式化日期为"几月几日"
        function formatDateToMonthDay(dateString) {
            if (!dateString) return '未提供';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '无效日期';
            
            const month = date.getMonth() + 1; // 月份从0开始，需要+1
            const day = date.getDate();
            
            return `${month}月${day}日`;
        }

        // 进度条控制函数
        const ProgressManager = {
            show(text = "处理中...") {
                const container = document.getElementById('global-progress-container');
                const progressText = document.getElementById('progress-text');
                
                container.classList.remove('hidden');
                progressText.textContent = text;
                this.update(0);
            },
            
            update(percent) {
                const bar = document.getElementById('global-progress-bar');
                const progressText = document.getElementById('progress-text');
                
                // 确保百分比在0-100范围内
                percent = Math.max(0, Math.min(100, percent));
                bar.style.width = `${percent}%`;
                
                // 更新文本显示百分比
                const currentText = progressText.textContent.replace(/\d+%/, '');
                progressText.textContent = `${currentText} ${percent.toFixed(0)}%`;
            },
            
            hide() {
                const container = document.getElementById('global-progress-container');
                container.classList.add('hidden');
            }
        };

        // 数据存储和管理
        const DataManager = {
            // 初始化数据
            init() {
                if (!localStorage.getItem('orderData')) {
                    localStorage.setItem('orderData', JSON.stringify([]));
                }
                if (!localStorage.getItem('searchHistory')) {
                    localStorage.setItem('searchHistory', JSON.stringify([]));
                }
                if (!localStorage.getItem('statistics')) {
                    localStorage.setItem('statistics', JSON.stringify({
                        importCount: 0,
                        lastImportDate: null
                    }));
                }
            },
            
            // 获取所有数据
            getAllData() {
                return JSON.parse(localStorage.getItem('orderData') || '[]');
            },
            
            // 保存数据
            saveData(data) {
                localStorage.setItem('orderData', JSON.stringify(data));
            },
            
            // 添加单条记录
            addRecord(record) {
                const data = this.getAllData();
                // 检查是否已存在相同运单号
                const existingIndex = data.findIndex(item => item.waybillNumber === record.waybillNumber);
                
                if (existingIndex >= 0) {
                    // 更新现有记录
                    data[existingIndex] = record;
                } else {
                    // 添加新记录
                    data.push(record);
                }
                
                this.saveData(data);
                return true;
            },
            
            // 批量添加记录（带进度更新）
            async batchAddRecords(records) {
                return new Promise((resolve) => {
                    const data = this.getAllData();
                    let addedCount = 0;
                    let updatedCount = 0;
                    const total = records.length;
                    
                    // 使用setTimeout模拟异步处理，以便更新进度条
                    function processRecord(index) {
                        if (index >= records.length) {
                            DataManager.saveData(data);
                            // 增加导入计数
                            DataManager.incrementImportCount();
                            resolve({ addedCount, updatedCount });
                            return;
                        }
                        
                        const record = records[index];
                        const existingIndex = data.findIndex(item => item.waybillNumber === record.waybillNumber);
                        
                        if (existingIndex >= 0) {
                            data[existingIndex] = record;
                            updatedCount++;
                        } else {
                            data.push(record);
                            addedCount++;
                        }
                        
                        // 更新进度
                        const progress = ((index + 1) / total) * 100;
                        ProgressManager.update(progress);
                        
                        // 继续处理下一条记录
                        setTimeout(() => processRecord(index + 1), 10);
                    }
                    
                    processRecord(0);
                });
            },
            
            // 增加导入计数
            incrementImportCount() {
                const stats = this.getStatistics();
                stats.importCount++;
                stats.lastImportDate = new Date().toISOString();
                localStorage.setItem('statistics', JSON.stringify(stats));
            },
            
            // 删除记录
            deleteRecord(waybillNumber) {
                let data = this.getAllData();
                const initialLength = data.length;
                data = data.filter(item => item.waybillNumber !== waybillNumber);
                
                if (data.length !== initialLength) {
                    this.saveData(data);
                    return true;
                }
                return false;
            },
            
            // 清空所有数据
            clearAllData() {
                localStorage.setItem('orderData', JSON.stringify([]));
                return true;
            },
            
            // 根据运单号查询
            queryByWaybillNumber(waybillNumber) {
                const data = this.getAllData();
                return data.find(item => item.waybillNumber === waybillNumber) || null;
            },
            
            // 添加查询历史
            addSearchHistory(waybillNumber) {
                let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                
                // 移除已存在的相同记录（避免重复）
                history = history.filter(item => item !== waybillNumber);
                
                // 添加到历史记录开头
                history.unshift(waybillNumber);
                
                // 限制历史记录数量为10条
                if (history.length > 10) {
                    history = history.slice(0, 10);
                }
                
                localStorage.setItem('searchHistory', JSON.stringify(history));
                return history;
            },
            
            // 获取查询历史
            getSearchHistory() {
                return JSON.parse(localStorage.getItem('searchHistory') || '[]');
            },
            
            // 获取统计信息
            getStatistics() {
                return JSON.parse(localStorage.getItem('statistics') || '{"importCount": 0, "lastImportDate": null}');
            }
        };

        // UI控制器
        const UIController = {
            // 初始化UI
            init() {
                this.renderDataTable();
                this.renderSearchHistory();
                this.updateStatistics();
                
                // 绑定事件
                this.bindEvents();
                
                // 绑定详情模态框关闭事件
                document.getElementById('close-detail').addEventListener('click', () => {
                    document.getElementById('detail-modal').classList.add('hidden');
                    document.getElementById('detail-modal').classList.remove('flex');
                });
            },
            
            // 绑定事件处理程序
            bindEvents() {
                // 查询表单提交
                document.getElementById('query-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleQuery();
                });
                
                // 文件上传区域点击
                document.getElementById('file-upload-area').addEventListener('click', () => {
                    document.getElementById('file-upload').click();
                });
                
                // 文件拖放
                const fileArea = document.getElementById('file-upload-area');
                fileArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileArea.classList.add('border-primary');
                });
                
                fileArea.addEventListener('dragleave', () => {
                    fileArea.classList.remove('border-primary');
                });
                
                fileArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileArea.classList.remove('border-primary');
                    
                    if (e.dataTransfer.files.length) {
                        this.handleFileUpload(e.dataTransfer.files[0]);
                    }
                });
                
                // 文件选择变化
                document.getElementById('file-upload').addEventListener('change', (e) => {
                    if (e.target.files.length) {
                        this.handleFileUpload(e.target.files[0]);
                    }
                });
                
                // 下载模板
                document.getElementById('download-template').addEventListener('click', () => {
                    ProgressManager.show("正在准备模板文件...");
                    
                    // 模拟处理进度
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 10;
                        ProgressManager.update(progress);
                        
                        if (progress >= 100) {
                            clearInterval(interval);
                            this.downloadTemplate();
                            setTimeout(() => ProgressManager.hide(), 500);
                        }
                    }, 50);
                });
                
                // 清空所有数据
                document.getElementById('clear-all-data').addEventListener('click', () => {
                    this.showConfirmModal(
                        '确认清空',
                        '您确定要清空所有数据吗？此操作不可恢复。',
                        () => {
                            ProgressManager.show("正在清空数据...");
                            
                            // 模拟处理进度
                            let progress = 0;
                            const interval = setInterval(() => {
                                progress += 20;
                                ProgressManager.update(progress);
                                
                                if (progress >= 100) {
                                    clearInterval(interval);
                                    DataManager.clearAllData();
                                    this.renderDataTable();
                                    this.updateStatistics();
                                    this.showStatusMessage('所有数据已清空', 'success');
                                    setTimeout(() => ProgressManager.hide(), 500);
                                }
                            }, 100);
                        }
                    );
                });
                
                // 帮助按钮
                document.getElementById('help-btn').addEventListener('click', () => {
                    document.getElementById('help-modal').classList.remove('hidden');
                    document.getElementById('help-modal').classList.add('flex');
                });
                
                // 关闭帮助
                document.getElementById('close-help').addEventListener('click', () => {
                    document.getElementById('help-modal').classList.add('hidden');
                    document.getElementById('help-modal').classList.remove('flex');
                });
                
                // 表格搜索
                document.getElementById('table-search').addEventListener('input', () => {
                    ProgressManager.show("正在搜索...");
                    
                    // 模拟搜索进度
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 20;
                        ProgressManager.update(progress);
                        
                        if (progress >= 100) {
                            clearInterval(interval);
                            this.currentPage = 1;
                            this.renderDataTable();
                            setTimeout(() => ProgressManager.hide(), 300);
                        }
                    }, 50);
                });
                
                // 分页按钮
                document.getElementById('prev-page').addEventListener('click', () => {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                        this.renderDataTableWithProgress();
                    }
                });
                
                document.getElementById('next-page').addEventListener('click', () => {
                    const data = this.getFilteredData();
                    const totalPages = Math.ceil(data.length / this.itemsPerPage);
                    
                    if (this.currentPage < totalPages) {
                        this.currentPage++;
                        this.renderDataTableWithProgress();
                    }
                });
            },
            
            // 带进度条的表格渲染
            renderDataTableWithProgress() {
                ProgressManager.show("加载数据中...");
                
                // 模拟加载进度
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 20;
                    ProgressManager.update(progress);
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        this.renderDataTable();
                        setTimeout(() => ProgressManager.hide(), 300);
                    }
                }, 50);
            },
            
            // 处理查询
            handleQuery() {
                const waybillNumber = document.getElementById('tracking-number').value.trim();
                
                if (!waybillNumber) {
                    this.showStatusMessage('请输入运单号', 'error');
                    return;
                }
                
                ProgressManager.show("正在查询...");
                
                // 模拟查询过程
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    ProgressManager.update(progress);
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        
                        const result = DataManager.queryByWaybillNumber(waybillNumber);
                        
                        if (result) {
                            // 显示结果
                            document.getElementById('result-waybill-number').textContent = result.waybillNumber;
                            document.getElementById('result-network-number').textContent = result.networkNumber || '未提供';
                            document.getElementById('result-main-number').textContent = result.mainNumber || '未提供';
                            document.getElementById('result-name').textContent = result.name || '未提供';
                            document.getElementById('result-owner').textContent = result.owner || '未提供';
                            document.getElementById('result-product').textContent = result.product || '未提供';
                            document.getElementById('result-quantity').textContent = result.quantity || '未提供';
                            document.getElementById('result-purchase-time').textContent = formatDateToMonthDay(result.purchaseTime);
                            document.getElementById('result-collection-point').textContent = result.collectionPoint || '未提供';
                            document.getElementById('result-responsible-dept').textContent = result.responsibleDept || '未提供';
                            document.getElementById('result-shipping-notes').textContent = result.shippingNotes || '未提供';
                            
                            document.getElementById('query-result').classList.remove('hidden');
                            this.showStatusMessage('查询成功', 'success');
                            
                            // 添加到查询历史
                            DataManager.addSearchHistory(waybillNumber);
                            this.renderSearchHistory();
                            this.updateStatistics();
                        } else {
                            // 隐藏结果
                            document.getElementById('query-result').classList.add('hidden');
                            this.showStatusMessage('未找到该运单号的记录', 'error');
                        }
                        
                        setTimeout(() => ProgressManager.hide(), 500);
                    }
                }, 50);
            },
            
            // 处理Excel文件上传
            handleFileUpload(file) {
                if (!file.name.endsWith('.xlsx')) {
                    this.showStatusMessage('请上传XLSX格式的Excel文件', 'error');
                    return;
                }
                
                ProgressManager.show("正在处理文件...");
                ProgressManager.update(10);
                
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        ProgressManager.update(20);
                        
                        // 解析Excel文件
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        ProgressManager.update(40);
                        
                        // 获取第一个工作表
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // 转换为JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        ProgressManager.update(60);
                        
                        if (jsonData.length === 0) {
                            this.showStatusMessage('Excel文件内容为空或格式不正确', 'error');
                            ProgressManager.hide();
                            return;
                        }
                        
                        // 处理记录
                        const records = this.processExcelData(jsonData);
                        
                        if (records.length === 0) {
                            this.showStatusMessage('未找到有效的记录，请检查Excel格式', 'error');
                            ProgressManager.hide();
                            return;
                        }
                        
                        ProgressManager.update(70);
                        
                        // 批量添加记录（带进度）
                        const { addedCount, updatedCount } = await DataManager.batchAddRecords(records);
                        
                        ProgressManager.update(90);
                        
                        this.renderDataTable();
                        this.updateStatistics();
                        this.showStatusMessage(`成功导入 ${addedCount} 条新记录，更新 ${updatedCount} 条现有记录`, 'success');
                        
                        ProgressManager.update(100);
                        setTimeout(() => ProgressManager.hide(), 500);
                    } catch (error) {
                        console.error('解析Excel文件出错:', error);
                        this.showStatusMessage('解析文件时出错，请检查文件格式', 'error');
                        ProgressManager.hide();
                    }
                };
                
                reader.onerror = () => {
                    this.showStatusMessage('读取文件时出错', 'error');
                    ProgressManager.hide();
                };
                
                reader.readAsArrayBuffer(file);
            },
            
            // 处理Excel数据
            processExcelData(jsonData) {
                const records = [];
                
                jsonData.forEach(item => {
                    // 检查是否有运单号
                    if (!item['运单号']) return;
                    
                    // 处理日期字段
                    let purchaseTime = this.processDate(item['下单时间']);
                    
                    records.push({
                        purchaseTime: purchaseTime,
                        name: item['姓名'] || '',
                        product: item['商品'] || '',
                        quantity: item['数量'] ? item['数量'].toString() : '',
                        networkNumber: item['网单号'] || '',
                        waybillNumber: item['运单号'].toString(),
                        owner: item['货主'] || '',
                        shippingNotes: item['发货备注'] || '',
                        mainNumber: item['主单号'] || '',
                        collectionPoint: item['揽收网点'] || '',
                        responsibleDept: item['责任部门'] || ''
                    });
                });
                
                return records;
            },
            
            // 处理日期
            processDate(dateValue) {
                if (!dateValue) return '';
                
                // Excel日期是从1900年1月1日开始的天数，需要转换
                if (typeof dateValue === 'number') {
                    // 处理Excel日期格式
                    const excelEpoch = new Date(1900, 0, 1);
                    const days = dateValue - 1; // Excel从1开始计数
                    const date = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
                    return date.toISOString();
                } else if (typeof dateValue === 'string') {
                    // 处理字符串日期
                    const date = new Date(dateValue);
                    return !isNaN(date.getTime()) ? date.toISOString() : '';
                }
                
                return '';
            },
            
            // 下载Excel模板
            downloadTemplate() {
                const today = new Date();
                
                // 创建工作簿和工作表
                const wb = XLSX.utils.book_new();
                
                // 模板数据（已移除订单时间）
                const templateData = [
                    {
                        '下单时间': today.toISOString().slice(0, 16).replace('T', ' '),
                        '姓名': '张三',
                        '商品': '电子产品',
                        '数量': 2,
                        '网单号': 'W123456789',
                        '运单号': 'SF1234567890123',
                        '货主': '张三科技有限公司',
                        '发货备注': '易碎品',
                        '主单号': 'ZD1122334455',
                        '揽收网点': '北京朝阳网点',
                        '责任部门': '销售一部'
                    },
                    {
                        '下单时间': today.toISOString().slice(0, 16).replace('T', ' '),
                        '姓名': '李四',
                        '商品': '服装',
                        '数量': 5,
                        '网单号': 'W987654321',
                        '运单号': 'YT9876543210987',
                        '货主': '李四贸易公司',
                        '发货备注': '',
                        '主单号': 'ZD6677889900',
                        '揽收网点': '上海浦东网点',
                        '责任部门': '销售二部'
                    }
                ];
                
                // 创建工作表
                const ws = XLSX.utils.json_to_sheet(templateData);
                
                // 添加工作表到工作簿
                XLSX.utils.book_append_sheet(wb, ws, "订单数据");
                
                // 生成并下载文件
                XLSX.writeFile(wb, "订单信息模板.xlsx");
            },
            
            // 渲染数据表格
            renderDataTable() {
                const tableBody = document.getElementById('data-table-body');
                const data = this.getFilteredData();
                const pagination = document.getElementById('pagination');
                
                // 分页设置
                this.itemsPerPage = 10;
                this.currentPage = this.currentPage || 1;
                const totalPages = Math.ceil(data.length / this.itemsPerPage);
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = Math.min(startIndex + this.itemsPerPage, data.length);
                const paginatedData = data.slice(startIndex, endIndex);
                
                if (data.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                <div class="flex flex-col items-center">
                                    <i class="fa fa-file-excel-o text-4xl mb-2 text-gray-300"></i>
                                    <p>暂无数据，请导入Excel文件</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    pagination.classList.add('hidden');
                    return;
                }
                
                // 显示分页
                pagination.classList.remove('hidden');
                document.getElementById('showing-range').textContent = `${startIndex + 1} - ${endIndex}`;
                document.getElementById('total-count').textContent = data.length;
                document.getElementById('page-info').textContent = `第 ${this.currentPage} / ${totalPages} 页`;
                
                // 禁用/启用分页按钮
                document.getElementById('prev-page').disabled = this.currentPage <= 1;
                document.getElementById('next-page').disabled = this.currentPage >= totalPages;
                
                // 渲染表格内容（已移除订单时间列）
                tableBody.innerHTML = paginatedData.map(item => `
                    <tr class="hover:bg-gray-50 transition-custom">
                        <td class="px-4 py-3 whitespace-nowrap">${item.waybillNumber}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${item.networkNumber || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${item.name || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${item.product || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${item.quantity || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${item.owner || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${item.collectionPoint || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <button 
                                class="text-blue-500 hover:text-blue-700 transition-custom mr-3"
                                onclick="UIController.showDetail('${item.waybillNumber}')"
                            >
                                <i class="fa fa-eye"></i> 详情
                            </button>
                            <button 
                                class="text-red-500 hover:text-red-700 transition-custom"
                                onclick="UIController.handleDeleteRecord('${item.waybillNumber}')"
                            >
                                <i class="fa fa-trash-o"></i> 删除
                            </button>
                        </td>
                    </tr>
                `).join('');
            },
            
            // 显示详情
            showDetail(waybillNumber) {
                ProgressManager.show("加载详情...");
                
                // 模拟加载进度
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 20;
                    ProgressManager.update(progress);
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        
                        const record = DataManager.queryByWaybillNumber(waybillNumber);
                        if (!record) {
                            ProgressManager.hide();
                            return;
                        }
                        
                        const detailContent = document.getElementById('detail-content');
                        // 详情中已移除订单时间
                        detailContent.innerHTML = `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="p-3 bg-neutral rounded-lg">
                                    <p class="text-xs text-gray-500">运单号</p>
                                    <p class="font-medium">${record.waybillNumber}</p>
                                </div>
                                <div class="p-3 bg-neutral rounded-lg">
                                    <p class="text-xs text-gray-500">网单号</p>
                                    <p class="font-medium">${record.networkNumber || '未提供'}</p>
                                </div>
                                <div class="p-3 bg-neutral rounded-lg">
                                    <p class="text-xs text-gray-500">主单号</p>
                                    <p class="font-medium">${record.mainNumber || '未提供'}</p>
                                </div>
                                <div class="p-3 bg-neutral rounded-lg">
                                    <p class="text-xs text-gray-500">姓名</p>
                                    <p class="font-medium">${record.name || '未提供'}</p>
                                </div>
                                <div class="p-3 bg-neutral rounded-lg">
                                    <p class="text-xs text-gray-500">货主</p>
                                    <p class="font-medium">${record.owner || '未提供'}</p>
                                </div>
                                <div class="p-3 bg-neutral rounded-lg">
                                    <p class="text-xs text-gray-500">商品</p>
                                    <p class="font-medium">${record.product || '未提供'}</p>
                                </div>
                                <div class="p-3 bg-neutral rounded-lg">
                                    <p class="text-xs text-gray-500">数量</p>
                                    <p class="font-medium">${record.quantity || '未提供'}</p>
                                </div>
                                <div class="p-3 bg-neutral rounded-lg">
                                    <p class="text-xs text-gray-500">下单时间</p>
                                    <p class="font-medium">${formatDateToMonthDay(record.purchaseTime)}</p>
                                </div>
                                <div class="p-3 bg-neutral rounded-lg">
                                    <p class="text-xs text-gray-500">揽收网点</p>
                                    <p class="font-medium">${record.collectionPoint || '未提供'}</p>
                                </div>
                                <div class="p-3 bg-neutral rounded-lg">
                                    <p class="text-xs text-gray-500">责任部门</p>
                                    <p class="font-medium">${record.responsibleDept || '未提供'}</p>
                                </div>
                                <div class="p-3 bg-neutral rounded-lg md:col-span-2">
                                    <p class="text-xs text-gray-500">发货备注</p>
                                    <p class="font-medium">${record.shippingNotes || '未提供'}</p>
                                </div>
                            </div>
                        `;
                        
                        document.getElementById('detail-modal').classList.remove('hidden');
                        document.getElementById('detail-modal').classList.add('flex');
                        
                        setTimeout(() => ProgressManager.hide(), 300);
                    }
                }, 50);
            },
            
            // 获取过滤后的数据
            getFilteredData() {
                const searchTerm = document.getElementById('table-search').value.trim().toLowerCase();
                let data = DataManager.getAllData();
                
                if (searchTerm) {
                    data = data.filter(item => 
                        item.waybillNumber.toLowerCase().includes(searchTerm) || 
                        item.networkNumber.toLowerCase().includes(searchTerm) ||
                        item.mainNumber.toLowerCase().includes(searchTerm) ||
                        item.name.toLowerCase().includes(searchTerm) ||
                        item.owner.toLowerCase().includes(searchTerm) ||
                        item.product.toLowerCase().includes(searchTerm) ||
                        item.collectionPoint.toLowerCase().includes(searchTerm) ||
                        item.responsibleDept.toLowerCase().includes(searchTerm)
                    );
                }
                
                // 按下单时间降序排序（原按订单时间排序，已调整）
                return data.sort((a, b) => {
                    if (!a.purchaseTime) return 1;
                    if (!b.purchaseTime) return -1;
                    return new Date(b.purchaseTime) - new Date(a.purchaseTime);
                });
            },
            
            // 处理删除记录
            handleDeleteRecord(waybillNumber) {
                this.showConfirmModal(
                    '确认删除',
                    `您确定要删除运单号为 ${waybillNumber} 的记录吗？`,
                    () => {
                        ProgressManager.show("正在删除...");
                        
                        // 模拟删除进度
                        let progress = 0;
                        const interval = setInterval(() => {
                            progress += 20;
                            ProgressManager.update(progress);
                            
                            if (progress >= 100) {
                                clearInterval(interval);
                                
                                if (DataManager.deleteRecord(waybillNumber)) {
                                    this.renderDataTable();
                                    this.updateStatistics();
                                    this.showStatusMessage('记录已删除', 'success');
                                }
                                
                                setTimeout(() => ProgressManager.hide(), 500);
                            }
                        }, 100);
                    }
                );
            },
            
            // 渲染搜索历史（当前已隐藏最近查询，但保留方法）
            renderSearchHistory() {
                // 由于已隐藏最近查询区域，此方法可以保持空实现
            },
            
            // 更新统计信息
            updateStatistics() {
                const totalRecords = DataManager.getAllData().length;
                document.getElementById('total-records').textContent = totalRecords;
            },
            
            // 显示状态消息
            showStatusMessage(message, type = 'info') {
                const statusEl = document.getElementById('status-message');
                statusEl.textContent = message;
                statusEl.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
                
                if (type === 'success') {
                    statusEl.classList.add('bg-green-100', 'text-green-800');
                    statusEl.innerHTML = `<i class="fa fa-check-circle"></i> <span>${message}</span>`;
                } else if (type === 'error') {
                    statusEl.classList.add('bg-red-100', 'text-red-800');
                    statusEl.innerHTML = `<i class="fa fa-exclamation-circle"></i> <span>${message}</span>`;
                } else {
                    statusEl.classList.add('bg-blue-100', 'text-blue-800');
                    statusEl.innerHTML = `<i class="fa fa-info-circle"></i> <span>${message}</span>`;
                }
                
                // 3秒后自动隐藏
                clearTimeout(this.statusTimeout);
                this.statusTimeout = setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            },
            
            // 显示确认对话框
            showConfirmModal(title, message, confirmCallback) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                
                const modal = document.getElementById('confirm-modal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // 绑定确认和取消事件
                const confirmBtn = document.getElementById('confirm-action');
                const cancelBtn = document.getElementById('cancel-confirm');
                
                // 移除之前的事件监听器
                const newConfirmBtn = confirmBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                // 添加新的事件监听器
                newConfirmBtn.addEventListener('click', () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    confirmCallback();
                });
                
                newCancelBtn.addEventListener('click', () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                });
            }
        };

        // 暴露UIController供内联事件使用
        window.UIController = UIController;

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            DataManager.init();
            UIController.init();
        });
    </script>
</body>
</html>
